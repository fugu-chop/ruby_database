#! /usr/bin/env ruby
require "pg"

DB = PG.connect(dbname:"expenses")
results = DB.exec("SELECT * FROM expenses ORDER BY created_on ASC;")

def add_expense(amount, memo)
  date = Date.today
  DB.exec("
    INSERT INTO expenses (amount, memo, created_at)
      VALUES (#{amount}, '#{memo}', '#{date}');
  ")
end

def display_help
puts <<~MSG
An expense recording system

Commands:

add AMOUNT MEMO [DATE] - record a new expense
clear - delete all expenses
list - list all expenses
delete NUMBER - remove expense with id NUMBER
search QUERY - list expenses with a matching memo field
MSG
end

def list(results)
  results.each do |tuple|
    row = [tuple["id"].rjust(3), tuple["created_on"].rjust(10), tuple["amount"].rjust(8), tuple["memo"]]
    puts row.join(" | ")
  end
end

case ARGV.first
when "list"
  list(results)
when "add"
  if ARGV.size == 3 
    add_expense(ARGV[1], ARGV[2]) 
  else 
    puts "You must provide an amount and memo."
  end
else
  display_help
end
